# [개발 로그] AI 얼굴 인식 대시보드 만들기: 삽질과 해결의 기록 (WebRTC 편)

## 1. 프로젝트 시작: "얼굴을 알아보는 웹 앱을 만들자"
**목표**: 웹캠으로 내 얼굴을 인식하고, 등록된 사람의 이름을 띄워주는 대시보드를 만들기로 함.
**스택 선정**:
- **언어**: Python
- **웹 프레임워크**: Streamlit
- **AI 모델**: Facenet-PyTorch (`MTCNN` + `InceptionResnetV1`)
- **영상 처리**: OpenCV + WebRTC (`streamlit-webrtc`)

## 2. 핵심 기능 발전기
처음에는 단순히 로컬에서 돌아가는 프로그램을 만들었지만, 실제 배포까지 고려하면서 프로젝트가 고도화되었습니다.
- **얼굴 탐지 & 인식**: `MTCNN`으로 위치를 찾고, `InceptionResnetV1`으로 얼굴의 특징점(임베딩)을 추출해 거리 기반으로 인물을 식별합니다.
- **한글 지원**: OpenCV 위에 `Pillow`를 얹어 맑은 고딕 폰트로 한글 이름을 부드럽게 출력했습니다.

## 3. 기술적 난관과 해결 (진정한 삽질 기록)

### 문제 1: 서버에 올리니 카메라가 안 나와요! (WebRTC 도입)
- **현상**: 로컬에선 잘 되는데, 클라우드 서버에 배포하면 카메라를 찾을 수 없다는 오류가 발생.
- **원인**: `cv2.VideoCapture(0)`는 서버 본체의 USB 포트를 찾기 때문. 사용자의 브라우저 카메라를 쓰려면 WebRTC가 필요했음.
- **해결**: `streamlit-webrtc` 라이브러리를 전격 도입. 브라우저를 통해 안전하게 영상을 주고받는 구조로 변경했습니다.

### 문제 2: "START" 버튼 누르는 것도 귀찮다! (자동 실행)
- **현상**: 매번 페이지를 열 때마다 Start 버튼을 눌러야 카메라가 켜짐.
- **해결**: `desired_playing_state=True` 옵션을 적용해, 페이지 접속과 동시에 카메라가 자동으로 가동되도록 개선했습니다.

### 문제 3: 등록했는데 왜 삭제 목록엔 안 뜨지? (동기화 이슈)
- **현상**: 새 얼굴을 등록해도 사이드바의 삭제 목록에는 나타나지 않음. 수동으로 새로고침을 해야만 반영됨.
- **해결**: **자동 폴링(Polling) 로직** 도입. 등록 버튼을 누르면 시스템이 백그라운드에서 완료를 확인(`get_registration_result`)하고, 성공 즉시 `st.rerun()`을 호출해 즉각적으로 목록을 갱신하게 고쳤습니다.

### 문제 4: 실시간 처리와 데이터 수정의 충돌 (Thread Safety)
- **현상**: 영상은 계속 돌아가는데 사이드바에서 이름을 삭제하거나 추가하면 간헐적으로 프로그램이 멈추거나 오류가 발생.
- **해결**: `threading.Lock`을 `FaceManager`에 적용하여, 데이터를 읽고 쓰는 과정에서 데이터 경쟁(Race Condition)이 발생하지 않도록 안전 장치를 마련했습니다.

## 4. 사용자 경험(UX) 디테일 잡기
- **UI 레이아웃**: 카메라 화면을 가리던 삭제 버튼을 사이드바의 선택창 바로 밑으로 이동시켜, 관리 동선을 최적화했습니다.
- **환경 분리**: 가상 환경(`venv`)과 전역 환경이 꼬여서 생기는 `ModuleNotFoundError`를 해결하는 가이드를 추가하여 배포 안정성을 높였습니다.

## 5. 최종 결과물
- **자동 가동**: 접속 시 즉시 확인 가능.
- **실시간 관리**: 등록 후 즉시 삭제 가능, 새로고침 불필요.
- **안정성**: WebRTC 기반으로 어디서든(HTTPS 필수) 접속 및 인식 가능.

## 6. 후기
단순히 모델을 돌리는 것을 넘어, **"실제로 사용 가능한 서비스 모델"**을 만드는 과정은 생각보다 훨씬 복잡했습니다. 특히 비동기적인 WebRTC 환경과 Streamlit의 Rerun 특성을 조화시키는 과정에서 많은 공부가 되었습니다. AI 어시스턴트와 함께 로직을 설계하고, 스레드 잠금이나 폴링 같은 백엔드 기술까지 접목해 보며 완성도를 높인 것이 가장 뿌듯합니다.

---
*이 프로젝트의 코드는 [GitHub 저장소 링크]에서 확인할 수 있습니다.*
